# PCD Viewer 任务执行系统

## 启动页 (新增功能)

### 任务管理界面
- **系统启动时首先显示启动页**，管理所有任务
- **任务列表**: 显示所有创建的任务，按状态和时间排序
- **任务状态标识**: 不同颜色的徽章显示任务状态
- **任务卡片信息**:
  - 任务名称和状态
  - 创建/开始/完成时间
  - 场景和航线配置状态
  - 航点完成进度（如有）
- **操作功能**:
  - ➕ 创建新任务（输入任务名称）
  - 🗑️ 删除任务（确认对话框）
  - ▶️ 打开任务（进入主界面）
- **默认任务**: 系统预置演示任务，方便快速体验

### 任务选择流程
1. 用户启动系统 → 显示启动页
2. 选择现有任务 或 创建新任务
3. 点击"打开任务" → 进入主界面
4. 主界面头部显示当前任务名称和返回按钮

## 完整任务流程

### 1. 用户创建任务
- 点击"创建新任务"，输入任务名称
- 新任务初始状态为 `draft`（草稿）

### 2. 配置任务
- **添加场景**: 上传.pcd文件或输入URL
- **添加编辑航线**: 上传.json文件或输入URL
- 完成配置后状态自动变为 `configured`（已配置）

### 3. 航线编辑
- 点击"开始编辑航线"，状态变为 `planning`
- 在3D视图中编辑航线：
  - 双击选中航点
  - 拖拽移动航点位置
  - Shift+点击添加新航点
  - Alt+点击删除航点
- 点击"确认航线，准备执行"，状态变为 `ready`

### 4. 执行任务
- 连接ROS系统
- 点击"开始任务"开始执行
- 状态变为 `running`，初始化航点状态：
  - 第一个航点设为 `active`（当前目标）
  - 其他航点为 `pending`（待执行）

### 5. 实时监控
- **位置跟踪**: 无人机3D模型实时更新位置和姿态
- **航点状态**: 
  - 🔵 蓝色：待执行 (`pending`)
  - 🟠 橙色：当前目标 (`active`)，尺寸稍大，有发光效果
  - 🟢 绿色：已完成 (`completed`)
  - ⚪ 灰色：已跳过 (`skipped`)
- **进度显示**: 左侧面板显示完成进度条和当前目标航点

### 6. 航点完成处理
- ROS发布航点到达消息 → 对应航点状态变为 `completed`
- 下一航点自动变为 `active`
- 支持暂停/恢复（如充电）：状态在 `running` 和 `paused` 间切换

### 7. 任务完成
- 到达最后一个航点或收到任务完成消息
- 状态变为 `completed` 或 `failed`
- 记录完成时间和执行日志
- 显示任务完成统计信息

## ROS消息接口

### 订阅话题

1. **位置话题**: `/odom_visualization/pose`
   ```
   消息类型: geometry_msgs/PoseStamped
   频率: 10-50 Hz
   用途: 实时更新无人机位置和姿态
   ```

2. **航点到达话题**: `/mission/waypoint_reached`
   ```
   消息类型: std_msgs/String (JSON格式)
   格式: {
     "waypoint_index": 0,
     "timestamp": 1699012345,
     "position": {"x": 1.0, "y": 2.0, "z": 3.0}
   }
   ```

3. **任务完成话题**: `/mission/complete`
   ```
   消息类型: std_msgs/String (JSON格式)
   格式: {
     "mission_id": "mission_001",
     "status": "completed|failed|returned",
     "timestamp": 1699012345,
     "reason": "All waypoints completed"
   }
   ```

## 状态机设计

```
draft → configured → planning → ready → running → completed
   ↓        ↓          ↓         ↓        ↓         ↑
  删除    重新配置   取消编辑   重新编辑   ↓     任务成功
                                    paused
                                      ↓
                                   failed
```

## 测试流程

### 1. 启动ROSBridge
```bash
roslaunch rosbridge_server rosbridge_websocket.launch
```

### 2. 运行模拟器（可选）
```bash
python3 ros_mission_simulator.py
```

### 3. 在应用中操作
1. 创建新任务
2. 添加场景文件（如 `/rosbag_play.pcd`）
3. 添加航线文件（如 `/example-planned-path.json`）
4. 点击"开始编辑航线"进入编辑模式
5. 编辑完成后点击"确认航线"
6. 连接ROS（如 `ws://localhost:9090`）
7. 点击"开始任务"开始执行

## 应用架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                    PCD Viewer 应用                           │
├─────────────────────────┬───────────────────────────────────┤
│     左侧控制面板         │          右侧3D渲染区域            │
│   (MissionController)   │         (PCDCanvas)              │
├─────────────────────────┼───────────────────────────────────┤
│ • 任务管理              │ • 点云渲染                        │
│ • ROS连接控制           │ • 编辑航线可视化                   │
│ • 显示设置              │ • 无人机模型                      │
│ • 航线编辑              │ • 3D交互操作                      │
└─────────────────────────┴───────────────────────────────────┘
```

## 2. 核心组件结构

### 2.1 主要组件层次
```
MissionController (主控制器)
├── MissionManager (任务管理)
├── ROS连接管理
├── 显示控制面板
└── PCDCanvas (3D渲染画布)
    ├── 点云渲染
    ├── 编辑航线渲染
    ├── 无人机模型渲染
    └── 交互控制
```

### 2.2 数据流向
```
用户操作 → 状态更新 → Props传递 → 3D渲染更新
```

## 3. 详细交互流程

### 3.1 任务管理流程
```
1. 应用启动
   ├── 加载默认任务 (默认任务包含默认点云和航线)
   ├── 自动选中第一个任务
   └── 触发点云加载

2. 创建新任务
   ├── 输入任务名称 → 点击"创建任务"
   ├── 生成新任务对象 → 添加到任务列表
   └── 自动选中新任务

3. 任务配置
   ├── 上传点云文件 (.pcd) 或输入URL
   ├── 上传航线文件 (.json) 或输入URL
   └── 实时预览更新
```

### 3.2 ROS连接与数据流
```
1. ROS连接建立
   ├── 点击"连接ROS" → 打开连接弹窗
   ├── 输入ROSBridge地址 (ws://host:port)
   ├── 建立WebSocket连接
   └── 显示连接状态

2. 数据订阅流程
   ├── 点击"开始任务" → 订阅位姿话题
   ├── 话题: /odom_visualization/pose
   ├── 消息类型: geometry_msgs/PoseStamped
   └── 实时更新无人机位置和姿态

3. 数据处理链路
   ROS话题 → ROSBridge → WebSocket → JavaScript → React状态 → 3D渲染
```

### 3.3 3D场景渲染流程
```
1. 点云渲染
   ├── PCDLoader加载.pcd文件
   ├── 解析几何体和颜色信息
   ├── 应用着色模式 (无/强度/高度)
   └── Three.js Points对象渲染

2. 编辑航线渲染
   ├── 解析JSON格式航线数据
   ├── 生成Line几何体 (航线)
   ├── 生成Sphere几何体 (航点)
   └── 支持颜色编码 (起点绿/终点红/中间蓝)

3. 无人机模型渲染
   ├── GLTF模型加载 (/drone/scene.gltf)
   ├── 材质和纹理应用
   ├── 位置和姿态实时更新
   └── 缩放和旋转调整
```

### 3.4 交互式编辑流程
```
1. 航线点选择
   ├── 双击航点球体 → 选中状态 (高亮显示)
   ├── ESC键或再次双击 → 取消选中
   └── 右下角显示选中点坐标

2. 拖拽编辑
   ├── 选中航点后 → 在拖拽平面上左键拖动
   ├── 实时更新点位置 → 保持固定轴坐标
   ├── 禁用相机控制 → 避免操作冲突
   └── 释放后重新启用相机

3. 添加/删除操作
   ├── Shift+点击参考平面 → 添加新航点
   ├── Alt+点击航点 → 删除该航点
   └── 实时更新航线显示

4. 拖拽平面切换
   ├── 选择XY/XZ/YZ平面
   ├── 可视化当前平面 (网格显示)
   ├── 自动相机对齐 (可选)
   └── 右下角显示平面信息
```

## 4. 状态管理

### 4.1 MissionController状态
```typescript
// 任务相关
selectedMission: Mission | null
missions: Mission[]

// ROS连接
rosUrl: string
rosConnected: boolean
dronePosition: DronePosition | null
missionRunning: boolean

// 显示控制
pointSize: number
showGrid: boolean
showAxes: boolean
colorMode: "none" | "intensity" | "height"

// 航线编辑
plannedPoints: Array<{x,y,z}> | null
plannedVisible: boolean
plannedEditable: boolean
plannedDragPlane: 'xy'|'xz'|'yz'
autoOrientPlane: boolean
```

### 4.2 PCDCanvas内部状态
```typescript
// 几何体数据
geom: THREE.BufferGeometry | null
bbox: THREE.Box3 | null

// 编辑状态
selectedIdx: number | null
draggingIdx: number | null
dragPlane: THREE.Plane | null
fixedVal: number
```

## 5. 用户界面布局

### 5.1 左侧控制面板 (320px宽)
```
┌─────────────────────────┐
│    任务管理区域          │
├─────────────────────────┤
│    任务控制按钮          │
├─────────────────────────┤
│    无人机状态显示        │
├─────────────────────────┤
│    显示设置             │
│  • 点大小滑块           │
│  • 网格/坐标轴开关       │
│  • 着色模式选择         │
├─────────────────────────┤
│    编辑航线控制          │
│  • 显示/编辑开关        │
│  • 拖拽平面选择         │
│  • 自动对齐开关         │
│  • 航点尺寸滑块         │
├─────────────────────────┤
│    点云信息显示          │
├─────────────────────────┤
│    视图适配按钮          │
└─────────────────────────┘
```

### 5.2 右侧3D渲染区域
```
┌─────────────────────────────────────┐
│  [连接ROS按钮] [订阅状态]  ← 右上角   │
│                                     │
│                                     │
│         3D Canvas 区域               │
│     • 点云渲染                       │
│     • 航线可视化                     │
│     • 无人机模型                     │
│     • 交互操作                       │
│                                     │
│                                     │
│              [平面标签] ← 右下角      │
│              [选中点坐标]             │
└─────────────────────────────────────┘
```

## 6. 关键交互特性

### 6.1 相机控制
- **OrbitControls**: 右键拖拽旋转视角
- **自动适配**: 点击"视图适配"按钮
- **平面对齐**: 切换拖拽平面时自动调整视角

### 6.2 多模式支持
- **点云着色**: 无着色/强度着色/高度着色
- **航线编辑**: 查看模式/编辑模式切换
- **实时数据**: ROS数据流实时更新

### 6.3 视觉反馈
- **选中高亮**: 选中航点变为橙色+发光效果
- **坐标显示**: 右下角实时显示选中点坐标
- **平面可视化**: 网格线显示当前拖拽平面
- **状态指示**: 连接状态、订阅状态、消息计数

## 7. 性能优化

### 7.1 渲染优化
- **LOD控制**: 大点云自动调整点大小上限
- **Frustum Culling**: 禁用frustumCulled确保大场景渲染
- **材质复用**: GLTF模型材质优化
- **预加载**: 模型文件预加载

### 7.2 交互优化
- **事件防抖**: 拖拽时避免频繁状态更新
- **冲突避免**: 拖拽时禁用相机控制
- **快速响应**: 本地状态优先，批量更新

## 8. 系统架构更新

### 8.1 启动页集成
- **主应用组件**: `src/app/page.tsx` 
  - 状态管理：选择的任务 / 启动页显示
  - 条件渲染：启动页 vs 主界面
  - 导航控制：返回任务列表按钮
- **启动页组件**: `src/components/StartupPage.tsx`
  - 任务列表管理：创建/删除/选择任务
  - 本地存储：localStorage持久化任务数据
  - 状态显示：任务状态徽章和进度信息
- **任务控制器**: `src/components/pcd/MissionController.tsx`
  - 支持初始任务参数：`initialMission` prop
  - 任务状态同步：启动页选择 → 主界面加载

### 8.2 数据持久化
- **任务存储**: `localStorage` 键值 `pcd-viewer-missions`
- **数据结构**: Mission[] 序列化JSON
- **日期处理**: 创建/开始/完成时间转换
- **默认数据**: 系统预置演示任务

### 8.3 用户体验优化
- **响应式设计**: 卡片布局适配不同屏幕
- **状态可视化**: 图标+颜色表示任务状态
- **操作反馈**: 确认对话框，加载状态
- **任务排序**: 运行中任务优先显示

## 9. 扩展性考虑

### 9.1 可扩展功能点
- **多无人机支持**: 扩展DronePosition为数组
- **航线类型**: 支持更多航线格式
- **实时轨迹**: 记录和显示历史轨迹
- **场景标注**: 添加3D标注功能
- **任务模板**: 预定义任务类型和配置

### 9.2 配置化支持
- **主题切换**: 支持明暗主题
- **布局调整**: 面板大小可调
- **快捷键**: 键盘快捷操作
- **预设配置**: 保存用户偏好设置
- **任务分类**: 支持任务标签和分组
