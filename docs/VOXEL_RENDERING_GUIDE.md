# 体素化渲染功能说明

## 功能概述

体素化渲染将传统的离散点云转换为密集的小立方体集合，形成实体化的视觉效果。这种渲染方式：

- ✅ 无需复杂的表面重建算法
- ✅ 视觉上更有"实体感"
- ✅ 适合建筑物、地形等场景的可视化
- ✅ 可调节体素大小以平衡视觉效果和性能

## 技术原理

### 体素化（Voxelization）

1. **空间划分**：将点云所在的3D空间划分为规则的立方体网格（体素）
2. **占用检测**：检查每个体素内是否包含点云数据
3. **立方体渲染**：在包含点云的体素位置渲染小立方体
4. **实例化优化**：使用 Three.js InstancedMesh 高效渲染大量立方体

### 性能优化

- **体素化降采样**：自动去除重复占用的体素，减少渲染数量
- **实例化渲染**：单次绘制调用渲染所有体素立方体
- **颜色顶点化**：将颜色信息直接写入实例属性，无需额外纹理

## 使用方法

### 1. 加载点云文件

支持的格式：
- `.pcd` - 点云数据文件（推荐用于体素化）
- `.ply` - 支持点云和网格

### 2. 启用体素化

在右侧控制面板中：

```
显示设置
  ✓ 场景点云
  
  ✓ 体素化渲染
    体素大小: [滑块] 0.050m
    越小越密集，性能开销越大
```

### 3. 调节参数

#### 体素大小（Voxel Size）

- **范围**：0.01m - 0.20m
- **默认**：0.05m（5厘米）
- **建议**：
  - 小场景（<10m）：0.02-0.05m
  - 中等场景（10-50m）：0.05-0.10m
  - 大场景（>50m）：0.10-0.20m

#### 着色模式

- **禁用**：灰色立方体
- **高度**：根据Z轴高度渲染彩色渐变（蓝→绿→黄→红）

## 性能考虑

### 体素数量估算

对于一个包含 N 个点的点云，体素数量约为：

```
体素数 ≈ N / (点密度 / 体素体积)
```

例如：
- 100万点，体素大小0.05m → 约20-50万个体素
- 100万点，体素大小0.10m → 约5-15万个体素

### 性能建议

| 体素数量 | 性能 | 帧率 | 建议 |
|---------|------|------|------|
| < 10万 | 优秀 | 60fps | 推荐使用 |
| 10-50万 | 良好 | 30-60fps | 可以使用 |
| 50-100万 | 一般 | 15-30fps | 增大体素尺寸 |
| > 100万 | 较差 | < 15fps | 不推荐 |

### 优化技巧

1. **调整体素大小**：增大体素减少渲染数量
2. **限制视野范围**：使用相机剪裁平面
3. **降采样**：预先对点云降采样
4. **LOD**：远处使用更大的体素

## 对比效果

### 传统点渲染 vs 体素化渲染

| 特性 | 点渲染 | 体素化渲染 |
|-----|-------|----------|
| 视觉效果 | 离散的点 | 密集的立方体 |
| 实体感 | 弱 | 强 |
| 性能开销 | 低 | 中等 |
| 适用场景 | 稀疏点云、扫描数据 | 建筑、地形、密集点云 |
| 细节保留 | 高（保留所有点） | 中（体素化降采样） |

## 代码实现

### 核心组件

1. **`src/lib/voxelizer.ts`** - 体素化算法
   - `voxelizePointCloud()` - 点云体素化
   - `getVoxelColors()` - 体素颜色计算

2. **`src/components/pcd/VoxelizedPointCloud.tsx`** - 渲染组件
   - 使用 Three.js InstancedMesh
   - 支持高度着色模式

### 使用示例

```tsx
import { VoxelizedPointCloud } from "@/components/pcd/VoxelizedPointCloud";

<VoxelizedPointCloud 
  geometry={pointCloudGeometry} 
  voxelSize={0.05}
  colorMode="height"
/>
```

## 未来改进

可能的增强功能：

1. **自适应体素大小**：根据相机距离自动调整
2. **八叉树优化**：加速体素查找和剔除
3. **LOD系统**：多级细节层次
4. **GPU加速**：使用计算着色器进行体素化
5. **更多着色模式**：法线、曲率、分类等

## 故障排除

### 问题：体素化后帧率很低

**解决方案**：
- 增大体素大小（例如从0.05m调到0.10m）
- 检查点云数量，考虑预先降采样
- 关闭不必要的渲染选项（网格、坐标轴等）

### 问题：体素化后看起来很"空"

**解决方案**：
- 减小体素大小
- 检查点云密度，可能点云本身就很稀疏
- 尝试调整着色模式以增强视觉效果

### 问题：颜色显示不正确

**解决方案**：
- 选择"高度"着色模式
- 检查点云是否有Z轴变化（平面点云无法显示高度渐变）
- 尝试切换回普通点渲染对比

## 参考资料

- [Three.js InstancedMesh](https://threejs.org/docs/#api/en/objects/InstancedMesh)
- [Voxel-based rendering](https://en.wikipedia.org/wiki/Voxel)
- [Point Cloud Library (PCL) - VoxelGrid](https://pointclouds.org/documentation/classpcl_1_1_voxel_grid.html)
