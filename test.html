<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drone Position Monitor</title>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.js"
    ></script>
  </head>
  <body>
    <h1>Drone Position Monitor</h1>

    <p>Connection: <span id="status" style="font-weight: bold">N/A</span></p>

    <h3>Drone Odometry Data:</h3>
    <pre
      id="drone-data"
      style="
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
      "
    >
Waiting for data...
    </pre>

    <h3>Livox Mid-360 Point Cloud Stats:</h3>
    <pre
      id="pointcloud-stats"
      style="
        background: #e8f4f8;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
      "
    >
Waiting for point cloud data...
    </pre>

    <script type="text/javascript">
      // Connect to ROS
      const ros = new ROSLIB.Ros({
        url: "ws://101.132.193.179:7001",
      });

      ros.on("connection", () => {
        document.getElementById("status").innerHTML = "Connected";
        console.log("Connected to ROS bridge");
      });

      ros.on("error", (error) => {
        document.getElementById("status").innerHTML = "Error: " + error;
        console.log("ROS connection error:", error);
      });

      ros.on("close", () => {
        document.getElementById("status").innerHTML = "Disconnected";
        console.log("ROS connection closed");
      });

      // Subscribe to drone odometry
      const droneOdomTopic = new ROSLIB.Topic({
        ros: ros,
        name: "/mavros/local_position/odom",
        messageType: "nav_msgs/msg/Odometry",
      });

      droneOdomTopic.subscribe((msg) => {
        console.log("Received drone odom:", msg);

        // Extract position and orientation
        const pos = msg.pose.pose.position;
        const orient = msg.pose.pose.orientation;
        const vel = msg.twist.twist.linear;
        const angular_vel = msg.twist.twist.angular;

        // Format data for display
        const displayData = `
时间戳: ${new Date().toLocaleTimeString()}
Header Frame: ${msg.header.frame_id}
Child Frame: ${msg.child_frame_id}

位置 (Position):
  X: ${pos.x.toFixed(3)} m
  Y: ${pos.y.toFixed(3)} m  
  Z: ${pos.z.toFixed(3)} m

姿态 (Orientation - Quaternion):
  X: ${orient.x.toFixed(3)}
  Y: ${orient.y.toFixed(3)}
  Z: ${orient.z.toFixed(3)}
  W: ${orient.w.toFixed(3)}

线速度 (Linear Velocity):
  X: ${vel.x.toFixed(3)} m/s
  Y: ${vel.y.toFixed(3)} m/s
  Z: ${vel.z.toFixed(3)} m/s

角速度 (Angular Velocity):
  X: ${angular_vel.x.toFixed(3)} rad/s
  Y: ${angular_vel.y.toFixed(3)} rad/s
  Z: ${angular_vel.z.toFixed(3)} rad/s
            `;

        document.getElementById("drone-data").textContent = displayData;
      });

      console.log("Subscribing to /mavros/local_position/odom");

      // Subscribe to Livox Mid-360 point cloud
      const pointCloudTopic = new ROSLIB.Topic({
        ros: ros,
        name: "/lidar/point_cloud", // 常见的 Livox 话题名，可能需要根据实际情况调整
        messageType: "sensor_msgs/PointCloud2",
      });

      pointCloudTopic.subscribe((msg) => {
        console.log("Received point cloud:", msg);

        // 计算点云统计信息
        const pointCount = msg.width * msg.height;
        const dataSize = msg.data.length;
        const bytesPerPoint = pointCount > 0 ? dataSize / pointCount : 0;

        // 从 fields 中获取字段信息
        const fields = msg.fields
          .map((field) => `${field.name} (${field.datatype})`)
          .join(", ");

        // 格式化统计信息显示
        const statsData = `
时间戳: ${new Date().toLocaleTimeString()}
Frame ID: ${msg.header.frame_id}
序列号: ${msg.header.stamp.sec}.${msg.header.stamp.nanosec}

点云基本信息:
  点数量: ${pointCount.toLocaleString()} 点
  宽度: ${msg.width}
  高度: ${msg.height}
  数据大小: ${(dataSize / 1024).toFixed(2)} KB
  每点字节数: ${bytesPerPoint.toFixed(1)} bytes
  
点云字段:
  ${fields}

数据属性:
  是否有序: ${msg.is_bigendian ? "大端序" : "小端序"}  
  点步长: ${msg.point_step} bytes
  行步长: ${msg.row_step} bytes
  是否稠密: ${msg.is_dense ? "是" : "否"}
            `;

        document.getElementById("pointcloud-stats").textContent = statsData;
      });

      console.log("Subscribing to /livox/lidar point cloud");

      const mapTopic = new ROSLIB.Topic({
        ros: ros,
        name: "/drone_0_grid/grid_map/occupancy_inflate",
        messageType: "sensor_msgs/PointCloud2",
      });
      mapTopic.subscribe((msg) => {
        console.log("Received map", msg);
      });
    </script>
  </body>
</html>
